{
  "init_parameters": {
    "output_file": "ddis_aurora_output"
  },
  "stages": {
    "version": {
        "steps": [
          {
            "description": "Version check",
            "command": [
              "syndicate",
              "--version"
            ],
            "checks": [
              {
                "index": 1,
                "name": "exit_code",
                "description": "Check if actual status code equals expected",
                "expected_exit_code": 0
              }
            ]
          }
        ]
    },
    "build": {
      "steps": [
        {
          "description": "Build bundle",
          "command": [
            "syndicate",
            "build"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if artifacts exist",
              "artifacts_list": [
                "build_meta.json",
                "sdct-at-ddis-aurora-1.0.0.jar"
              ],
              "depends_on": [
                1
              ]
            },
            {
              "index": 3,
              "name": "build_meta",
              "description": "Check if all resources exist in build meta",
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster"
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance"
                }
              },
              "depends_on": [
                1
              ]
            },
            {
              "index": 4,
              "name": "build_meta_content",
              "description": "Check if all resources in build meta contain required meta",
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test",
                    "project-level-tag": "set-from-resource"
                  }
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  },
                  "env_variables": {
                    "MASTER_CREDENTIALS_SECRET_NAME": {
                      "resource_type": "rds_db_cluster",
                      "parameter": "master_user_secret_name",
                      "resource_name": "sdct-at-rds-db-cluster"
                    },
                    "ENDPOINT": {
                      "resource_type": "rds_db_cluster",
                      "parameter": "endpoint",
                      "resource_name": "sdct-at-rds-db-cluster"
                    }
                  }
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                }
              },
              "depends_on": [
                1
              ]
            }
          ]
        }
      ],
      "depends_on": [
        "version"
      ]
    },
    "deploy": {
      "steps": [
        {
          "description": "Deployment without dependencies",
          "command": [
            "syndicate",
            "deploy"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [
                1
              ]
            },
            {
              "index": 3,
              "name": "deployment_output",
              "description": "Check if all resources present in deployment output",
              "succeeded_deploy": true,
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster"
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance"
                }
              },
              "depends_on": [
                1,
                2
              ]
            },
            {
              "index": 4,
              "name": "resource_existence",
              "description": "Check if all resources present in account",
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster"
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance"
                }
              },
              "depends_on": [
                1,
                2,
                3
              ]
            },
            {
              "index": 5,
              "name": "tag_existence",
              "description": "Check if tags is present",
              "resources": {
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test",
                    "project-level-tag": "set-from-project"
                  }
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test",
                    "project-level-tag": "set-from-project"
                  }
                }
              },
              "depends_on": [
                1,
                2
              ]
            }
          ]
        }
      ],
      "depends_on": [
        "build"
      ]
    },
    "update": {
      "steps": [
        {
          "description": "Updating resources",
          "command": [
            "syndicate",
            "update",
            "--force"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [
                1
              ]
            },
            {
              "index": 3,
              "name": "deployment_output",
              "description": "Check if all resources present in deployment output",
              "succeeded_deploy": true,
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster"
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance"
                }
              },
              "depends_on": [
                1
              ]
            },
            {
              "index": 4,
              "name": "lambda_env_existence",
              "description": "Check if lambda environment variables were updated",
              "env_variables": {
                "sdct-at-java-lambda": {
                  "ENDPOINT": "*${region}.rds.amazonaws.com",
                  "MASTER_CREDENTIALS_SECRET_NAME": "rds!cluster*"
                }
              },
              "depends_on": [
                1,
                2
              ]
            },
            {
              "index": 5,
              "name": "tag_existence",
              "description": "Check if tags is present",
              "resources": {
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test",
                    "project-level-tag": "set-from-project"
                  }
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test",
                    "project-level-tag": "set-from-project"
                  }
                }
              },
              "depends_on": [
                1,
                2
              ]
            }
          ]
        }
      ],
      "depends_on": [
        "deploy"
      ]
    },
    "clean": {
      "steps": [
        {
          "description": "Clean all resources",
          "command": [
            "syndicate",
            "clean"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file does not exist in S3 bucket",
              "succeeded_deploy": true,
              "reverse_check": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [
                1
              ]
            },
            {
              "index": 3,
              "name": "resource_existence",
              "reverse_check": true,
              "description": "Check if all resources are not present in account",
              "resources": {
                "sdct-at-lambda-basic-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-java-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-java-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-rds-db-cluster": {
                  "resource_type": "rds_db_cluster"
                },
                "sdct-at-rds-db-instance": {
                  "resource_type": "rds_db_instance"
                }
              },
              "depends_on": [
                1
              ]
            }
          ]
        }
      ],
      "depends_on": [
        "build",
        "deploy"
      ]
    }
  }
}