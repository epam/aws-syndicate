{
  "init_parameters": {
    "output_file": "least_used_output"
  },
  "stages": {
    "build": {
      "steps": [
        {
          "description": "Build bundle",
          "command": ["syndicate", "build"],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if artifacts exist",
              "artifacts_list": [
                "build_meta.json"
              ],
              "depends_on": [1]
            },
            {
              "index": 3,
              "name": "build_meta",
              "description": "Check if all resources exist in build meta",
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1]
            },
            {
              "index": 4,
              "name": "build_meta_content",
              "description": "Check if all resources in build meta contain required meta",
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions",
                  "tags": {
                    "tests": "smoke",
                    "project": "sdct-auto-test"
                  }
                }
              },
              "depends_on": [1]
            }
          ]
        }
      ]
    },
    "deploy": {
      "steps": [
        {
          "description": "IAM resources deployment",
          "command": [
            "syndicate", "deploy", "-types", "iam_policy", "-types", "iam_role"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [1]
            },
            {
              "index": 3,
              "name": "deployment_output",
              "description": "Check if all resources present in deployment output",
              "succeeded_deploy": true,
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                }
              },
              "depends_on": [1, 2]
            },
            {
              "index": 4,
              "name": "resource_existence",
              "description": "Check if all resources present in account",
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                }
              },
              "depends_on": [1, 2, 3]
            }
          ]
        },
        {
          "description": "Deployment without dependencies",
          "command": [
            "syndicate", "deploy", "--continue_deploy"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [1]
            },
            {
              "index": 3,
              "name": "deployment_output",
              "description": "Check if all resources present in deployment output",
              "succeeded_deploy": true,
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1, 2]
            },
            {
              "index": 4,
              "name": "resource_existence",
              "description": "Check if all resources present in account",
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1, 2, 3]
            }
          ]
        }
      ],
      "depends_on": ["build"]
    },
    "clean": {
      "steps": [
        {
          "description": "Partial clean resources",
          "command": [
            "syndicate", "clean", "-resources", "sdct-at-job-definition"
          ],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [1]
            },
            {
              "index": 3,
              "name": "deployment_output",
              "description": "Check if all resources present in succeeded deployment output",
              "succeeded_deploy": true,
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1, 2]
            },
            {
              "index": 4,
              "name": "deployment_output",
              "description": "Check if resources are not present in deployment output",
              "succeeded_deploy": true,
              "reverse_check": true,
              "resources": {
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                }
              },
              "depends_on": [1, 2]
            },
            {
              "index": 5,
              "name": "resource_existence",
              "description": "Check if all resources present in account and were not deleted",
              "resources": {
                "sdct-at-lambda-execution-policy": {
                  "resource_type": "iam_policy"
                },
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1, 2, 3]
            },
            {
              "index": 6,
              "name": "resource_existence",
              "reverse_check": true,
              "description": "Check if resources are not present in account",
              "resources": {
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                }
              },
              "depends_on": [1, 2]
            }
          ]
        },
        {
          "description": "Clean all remaining resources",
          "command": ["syndicate", "clean"],
          "checks": [
            {
              "index": 1,
              "name": "exit_code",
              "description": "Check if actual status code equals expected",
              "expected_exit_code": 0
            },
            {
              "index": 2,
              "name": "artifacts_existence",
              "description": "Check if succeeded deployment output file exists in S3 bucket",
              "succeeded_deploy": true,
              "reverse_check": true,
              "artifacts_list": [
                "autotest.json"
              ],
              "depends_on": [1]
            },
            {
              "index": 3,
              "name": "resource_existence",
              "reverse_check": true,
              "description": "Check if all resources are not present in account",
              "resources": {
                "sdct-at-batch-job-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-step-function-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-lambda-role": {
                  "resource_type": "iam_role"
                },
                "sdct-at-python-lambda": {
                  "resource_type": "lambda"
                },
                "sdct-at-compenv": {
                  "resource_type": "batch_compenv"
                },
                "sdct-at-job-queue": {
                  "resource_type": "batch_jobqueue"
                },
                "sdct-at-job-definition": {
                  "resource_type": "batch_jobdef"
                },
                "sdct-at-socket-api": {
                  "resource_type": "web_socket_api_gateway"
                },
                "sdct-at-step-function": {
                  "resource_type": "step_functions"
                },
                "sdct-at-cw-alarm": {
                  "resource_type": "cloudwatch_alarm"
                }
              },
              "depends_on": [1]
            }
          ]
        }
      ],
      "depends_on": ["build"]
    }
  }
}